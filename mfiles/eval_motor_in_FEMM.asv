%% eval_motor_in_FEMM.m
% runs a set of FEA simulations according to the id, iq values given from outside
% - MO_OA is when the script is called by the optimization alogorithm
% - singt and singm are when it is called by 

function [out] = eval_motor_in_FEMM(geo,io,gamma_in)

global eval_type options_global

switch eval_type
    case 'MO_OA'
        gamma = gamma_in;
        nsim = geo.nsim_MOOA;
        delta_sim = geo.delta_sim_MOOA;
    case 'singt'
        nsim = geo.nsim_singt; delta_sim = geo.delta_sim_singt;gamma = gamma_in;
        
end
keyboard

SOL = [];
T = zeros(1,length(gamma)); fd = T; fq = T; ripple = T;
Pfe_S_tot = T; Pfe_R_tot = T;

    
kk = 1;
SOL(:,:,kk) = simulate_xdeg(geo,nsim,delta_sim,io,gamma(kk)); % risultati
        SOL(:,2,kk)=SOL(:,2,kk)/geo.Nbob;
        SOL(:,3,kk)=SOL(:,3,kk)/geo.Nbob;
        SOL(:,4,kk)=SOL(:,4,kk)*geo.Nbob;
        SOL(:,5,kk)=SOL(:,5,kk)*geo.Nbob;

ris_sim = SOL(1:end-1,:,kk);

T(kk) = abs(mean(ris_sim(:,6)));
ripple(kk) = std(ris_sim(:,6));
fd(kk) = mean(ris_sim(:,4));
fq(kk) = mean(ris_sim(:,5));
    
out.SOL = SOL(1:end-1,:,:);
out.Tn = T;
out.ripple_pu = ripple./T;
out.fd = fd;
out.fq = fq;

save sim_mot_temp out

